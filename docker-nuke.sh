#!/usr/bin/env bash
#
# docker-nuke.sh â€” Ğ½ĞµĞ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¸Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ Docker-ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
# Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ:
#   ./docker-nuke.sh        # Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ°Ñ” Ğ¿Ñ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¶ĞµĞ½Ğ½Ñ
#   ./docker-nuke.sh -y     # Ğ·Ğ½Ğ¸Ñ‰Ğ¸Ñ‚ÑŒ ÑƒÑĞµ Ğ±ĞµĞ· Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ°Ğ½ÑŒ
#
# ĞŸĞ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ñ– Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ–: docker CLI Ğ² $PATH

set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
confirm() {
  if [[ "${1:-}" == "-y" ]]; then
    return            # Ğ¾Ğ¿Ñ†Ñ–Ñ -y â†’ Ğ±ĞµĞ· Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ°Ğ½ÑŒ
  fi
  read -rp $'âš ï¸  Ğ¦Ğµ Ğ½Ğ°Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ’Ğ¡Ğ† ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¸, Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸, Ñ‚Ğ¾Ğ¼Ğ¸ Ğ¹ Ğ¼ĞµÑ€ĞµĞ¶Ñ– Docker!\nĞŸÑ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶Ğ¸Ñ‚Ğ¸? [y/N] ' ans
  [[ "$ans" =~ ^([yY]|yes|YES)$ ]] || { echo "Ğ¡ĞºĞ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¾."; exit 0; }
}

run_safe() {
  local cmd="$1"
  # xargs -r â†’ Ğ½Ğµ Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑ” ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ, ÑĞºÑ‰Ğ¾ Ğ²Ñ…Ñ–Ğ´ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹
  eval "$cmd" || true # Ğ½Ğµ Ğ²Ğ°Ğ»Ğ¸Ñ‚Ğ¸ÑÑ, ÑĞºÑ‰Ğ¾ Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
confirm "${1:-}"

echo "â¹  Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° Ñ‚Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ–Ğ²..."
run_safe 'docker ps -aq | xargs -r docker rm -f'

echo "ğŸ—‘  Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ–Ğ²..."
run_safe 'docker images -q | xargs -r docker rmi -f'

echo "ğŸ§¹  Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ¼Ñ–Ğ²..."
run_safe 'docker volume ls -q | xargs -r docker volume rm -f'

echo "ğŸŒ  Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ¸Ñ… Ğ¼ĞµÑ€ĞµĞ¶..."
run_safe 'docker network ls -q --filter type=custom | xargs -r docker network rm'

echo "ğŸš¿  Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°Ğ»ÑŒĞ½Ğµ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ (docker system prune)..."
docker system prune -af --volumes

echo "âœ…  Docker-ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ Ğ¿Ğ¾Ğ²Ğ½Ñ–ÑÑ‚Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¾."

